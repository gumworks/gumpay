<html>
    <head>
        <script
        src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
        crossorigin="anonymous"></script>
    </head>
    <body>
        <form style="margin: 20px;">
            <div id="step1">
                <h3>Step 1 - Insert your API Key and retrieve preautorization link for your user</h3>
                <p>
                <label for="userid">Shop API Key</label><input type="text" id="uniquekey" size="200" value=""/>
                </p>    
                <p>
                <label for="userid">External User Id</label><input type="text" id="externaluserid" size="200" value=""/>
                </p>
                <button type="button" onclick="javascript:getauthorizationlink()">Send</button>
                <br><a id="alink" target="_blank"></a>
            </div>
            <br>
            <br>
            <br>
            <div id="step2" style="display: none;">
                <h3>Step 2 - After scan previous link and activate the preautorization, Set amount that will be preauthorized, this will return a token to identify this preauthorization</h3>
                <label for="amount">Amount</label><input type="text" id="amount" value="50"/>
                <button type="button" onclick="javascript:preauthtransaction()">Send</button>
            </div>
            <br>
            <br>
            <br>
            <div id="step3" style="display: none;">
                <h3>Step 3 - with the token received, you are able to capture the payment or cancel it</h3>
                <input type="text" id="token" value=""/>
                <label for="finalamount">Final Amount</label><input type="text" id="finalamount" value="20"/>
                <button type="button" onclick="javascript:capturetransaction()">Capture</button>
                <button type="button" onclick="javascript:canceltransaction()">Cancel</button>
            </div>
        </form>
          <script lang="javascript">
              function getauthorizationlink()
              {
                $.post( "demo.php", { action: "getpreauthlink",  uniquekey: $('#uniquekey').val(), externalUserId: $('#externaluserid').val(), returnUrl: window.location.protocol + '//' + window.location.hostname + '/demo.php?action=preauth' })
                .done(function( data ) {
                    $('#alink').attr('href', data.link);
                    $('#alink').text(data.link);
                    $('#step2').show();
                });
              }
             
              function preauthtransaction()
              {
                $.post( "demo.php", { action: "preauthorizetransaction", uniquekey: $('#uniquekey').val(), externalUserId: $('#externaluserid').val() , amount: $('#amount').val() })
                .done(function( data ) {
                    if(data.result)
                    {
                        alert('Preauthorization Token Received: '  + data.token);
                        $('#token').val(data.token);
                        $('#step3').show();
                    }
                    else
                    {
                        alert(data.result_text);
                    }
                });
              }

              function capturetransaction()
              {
                $.post( "demo.php", { action: "capturetransaction", uniquekey: $('#uniquekey').val(), token: $('#token').val(),  externalUserId: $('#externaluserid').val() , amount: $('#finalamount').val() })
                .done(function( data ) {
                    if(data.result)
                    {
                        alert("Transaction Captured, Payment processed OK!");
                    }
                    else
                    {
                        alert(data.result_text);
                    }
                });
              }

              function canceltransaction()
              {
                $.post( "demo.php", { action: "canceltransaction", uniquekey: $('#uniquekey').val(), token: $('#token').val(), externalUserId: $('#externaluserid').val()})
                .done(function( data ) {
                    if(data.result)
                    {
                        alert("Preauthorized transaction canceled OK!");
                    }
                    else
                    {
                        alert(data.result_text);
                    }
                });

              }

              function loadpreauthorizedusers()
              {
                $.post( "demo.php", { action: "loadpreauthorizedusers", uniquekey: $('#uniquekey').val() })
                .done(function( data ) {
                    if(data.result)
                    {
                        $.each(data.users, function(ix, user){
                            $('#userid').append(new Option(user.ShortName, user.UserId));
                        });
                    }
                    else
                    {
                        alert(data.result_text);
                    }
                    
                });

              }
</script>
    </body>
</html>